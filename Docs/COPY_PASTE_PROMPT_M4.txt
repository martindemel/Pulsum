ROLE: You are a principal iOS architect and senior SwiftUI engineer continuing the Pulsum health AI app. Milestones 0-3 are COMPLETE (agent system, data layer, services, Foundation Models integration - 4,865+ lines of production code). Your job is to implement Milestone 4: UI & Experience Build - the production SwiftUI interface. This is production code for App Store submission - no placeholders, no examples, no mock UIs.

CRITICAL FIRST STEP - COMPREHENSIVE CODEBASE ANALYSIS:
Initially, analyze the ENTIRE codebase, including all folders and subfolders, as well as all files within these folders, to understand what is already available from the Xcode project. Do not skip lines; read it all. This ensures you have complete context and can identify anything that might have been missed.

ANALYZE ALL FILES IN:
â€¢ Pulsum/ (app target: PulsumApp.swift, ContentView.swift, Core Data model, assets)
â€¢ Packages/PulsumAgents/Sources/ (all 7 agent files - read every line to understand APIs)
â€¢ Packages/PulsumML/Sources/ (Foundation Models providers, ML algorithms, embeddings, safety)
â€¢ Packages/PulsumServices/Sources/ (HealthKit, Speech, LLM, Keychain services)
â€¢ Packages/PulsumData/Sources/ (DataStack, VectorIndex, LibraryImporter, Core Data entities)
â€¢ Packages/PulsumUI/Sources/ (current state - what exists already)
â€¢ All Package.swift files (verify dependencies, platforms, frameworks)
â€¢ Test files across all packages (understand patterns)
â€¢ /ios support documents/ (Liquid Glass guidance)
â€¢ /json database/ (podcast recommendations data)

WHAT TO VERIFY:
âœ“ AgentOrchestrator public API methods (your UI interface)
âœ“ Return types (JournalCaptureResponse, RecommendationResponse, etc.)
âœ“ Foundation Models integration points
âœ“ Error types to handle
âœ“ Core Data entities available
âœ“ Existing view implementations (if any)
âœ“ Package dependencies and imports
âœ“ Any gaps or missing implementations

THEN READ THESE DOCUMENTATION FILES (DO NOT SKIP ANY LINES):
1. @instructions.md - Complete product specification, UI navigation, agent architecture, Foundation Models requirements
2. @todolist.md - Milestone status (0-3 done, 4-6 pending), your specific Milestone 4 tasks
3. @pulsumvalidationmilestone3.md - Complete architecture review (1,736 lines), agent system design, data flows, what's ready for UI integration
4. @MILESTONE_3_COMPLETION_ANALYSIS.md - Verification that M3 is 100% complete, Swift 6 compliant, production-ready
5. @archchangem3.md - Milestone 3 rebuild documentation, Foundation Models implementation details
6. @DOCUMENTATION_UPDATES_SEPT_30.md - Latest alignment, Milestone 4 patterns, code examples
7. @EXTERNAL_REVIEW_ANALYSIS.md - Architecture validation (A- grade), SpeechAnalyzer requirement, Privacy Manifest requirement

WHAT'S ALREADY BUILT (Milestone 0-3 Complete):
âœ… AgentOrchestrator (144 lines): @MainActor manager, Foundation Models-aware, async API with methods: start(), recordVoiceJournal(), submitTranscript(), updateSubjectiveInputs(), recommendations(), chat(), logCompletion(), foundationModelsStatus property
âœ… DataAgent (1,017 lines): Sophisticated health analytics, HealthKit ingestion, StateEstimator, feature vectors
âœ… SentimentAgent (106 lines): Foundation Models sentiment, PII redaction, on-device STT, vector persistence
âœ… CoachAgent (265 lines): Vector search, RecRanker ML, Foundation Models intelligent caution, consent routing
âœ… SafetyAgent (56 lines): Dual-provider (Foundation Models + SafetyLocal), crisis detection
âœ… CheerAgent (33 lines): Completion celebration
âœ… All ML: StateEstimator, RecRanker, BaselineMath
âœ… All Services: HealthKit, Speech, LLMGateway, Keychain
âœ… All Data: Core Data (9 entities), VectorIndex, LibraryImporter
âœ… Swift 6 compliant (zero warnings), all tests passing

YOUR MILESTONE 4 TASKS (14 total):
1. Create SwiftUI views: MainView (SplineRuntime + navigation), CoachView (cards + chat), PulseView (voice + sliders), SettingsView (consent + Foundation Models status), SafetyCardView
2. Remove legacy ContentView.swift and Persistence.swift
3. Apply Liquid Glass design (reference: /ios support documents/)
4. Integrate SplineRuntime: https://build.spline.design/ke82QL0jX3kJzGuGErDD/scene.splineswift (cloud) + mainanimation.splineswift (fallback)
5. **Create @MainActor view models** binding to AgentOrchestrator with async/await patterns
6. Connect UI ONLY to AgentOrchestrator (never individual agents)
7. **Display Foundation Models availability** in SettingsView (orchestrator.foundationModelsStatus)
8. **Implement loading states** for async operations (sentiment, safety, coaching)
9. **Add fallback messaging** when Foundation Models unavailable
10. **Validate error handling** for Foundation Models (guardrailViolation, refusal)
11. **Migrate to SpeechAnalyzer/SpeechTranscriber** (iOS 26+) with SFSpeechRecognizer fallback
12. Wire navigation: Pulse buttonâ†’PulseView, Avatarâ†’SettingsView, AI buttonâ†’Coach+focus chat
13. Accessibility/localization (Dynamic Type, VoiceOver)
14. Consent banner with exact copy from instructions.md

REQUIRED PATTERNS (From instructions.md):

@MainActor View Models:
```swift
@MainActor
@Observable
final class CoachViewModel {
    private let orchestrator: AgentOrchestrator
    var recommendations: [RecommendationCard] = []
    var isLoading = false
    
    func loadRecommendations(consentGranted: Bool) async {
        isLoading = true
        defer { isLoading = false }
        let response = try await orchestrator.recommendations(consentGranted: consentGranted)
        recommendations = response.cards
    }
}
```

Loading States:
```swift
.overlay {
    if isLoading {
        ProgressView("Analyzing...")
    }
}
.disabled(isLoading)
```

Foundation Models Error Handling:
```swift
catch let error as LanguageModelSession.GenerationError {
    switch error {
    case .guardrailViolation:
        showError("Let's keep the focus on supportive wellness actions")
    case .refusal:
        showError("Unable to process that request. Try rephrasing.")
    }
}
```

Safety Decision Handling:
```swift
let response = try await orchestrator.recordVoiceJournal(maxDuration: 30)
if !response.safety.allowCloud, case .crisis = response.safety.classification {
    showCrisisCard(message: response.safety.crisisMessage ?? "If in danger, call 911")
}
```

CRITICAL CONSTRAINTS:
â€¢ UI connects ONLY to AgentOrchestrator (never individual agents)
â€¢ All view models @MainActor with async/await
â€¢ Display orchestrator.foundationModelsStatus in SettingsView
â€¢ Show loading states during all async operations
â€¢ Handle Foundation Models errors (guardrailViolation, refusal)
â€¢ Display fallback messaging when Foundation Models unavailable
â€¢ Apply Liquid Glass design from /ios support documents/
â€¢ Respect SafetyDecision.allowCloud
â€¢ Show consent banner before first cloud call (exact copy in instructions.md)
â€¢ Recording indicator always visible during voice capture
â€¢ No audio storage (transcript only)
â€¢ Zero placeholders or "Coming Soon" stubs
â€¢ Production-quality code for App Store

EXECUTION CHECKLIST (Follow This Sequence):
â–¡ Phase 1: Analyze entire codebase (all packages, all files, all lines)
â–¡ Phase 2: Read all 7 documentation files completely  
â–¡ Phase 3: Cross-reference docs vs actual code
â–¡ Phase 4: Understand AgentOrchestrator API surface
â–¡ Phase 5: Create @MainActor view models
â–¡ Phase 6: Implement all views (Main, Coach, Pulse, Settings, SafetyCard)
â–¡ Phase 7: Migrate to SpeechAnalyzer with fallback
â–¡ Phase 8: Apply Liquid Glass design
â–¡ Phase 9: Wire all navigation flows
â–¡ Phase 10: Test end-to-end
â–¡ Phase 11: Update todolist.md marking M4 complete

DO NOT START CODING UNTIL CODEBASE ANALYSIS AND DOCUMENTATION REVIEW ARE COMPLETE.

The sophisticated agent system (4,865+ lines) is production-ready and waiting - build a UI worthy of it! ðŸš€
