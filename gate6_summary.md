# Gate 6 — ML correctness & personalization

## Code changes
- `Packages/PulsumAgents/Sources/PulsumAgents/DataAgent.swift`, `Packages/PulsumAgents/Tests/PulsumAgentsTests/Gate6_WellbeingBackfillPhasingTests.swift`: `start()`/`requestHealthAccess()` now perform a 2-day bootstrap synchronously for a fast first score, then schedule the 7-day warm-start + 30-day backfill in the background. Snapshot notifications are debounced to a single `.pulsumScoresUpdated` per batch with per-batch log summaries.
- `Packages/PulsumUI/Sources/PulsumUI/CoachViewModel.swift`: keeps wellbeing state in the last known value after the first load so background backfill no longer flips the main card back to “Calculating…”.
- `Packages/PulsumAgents/Sources/PulsumAgents/DebugLogBuffer.swift`: increased capacity (2000 lines) and added test-only reset; `DebugLogBufferTests` guard ring buffer behavior.
- `Packages/PulsumML/Sources/PulsumML/StateEstimator.swift`, `Packages/PulsumAgents/Sources/PulsumAgents/DataAgent.swift`: added `WellbeingModeling` normalization/clamping, corrected seed weights (recovery-positive), sentiment weight, and persisted estimator state via versioned JSON with full file protection.
- `Packages/PulsumAgents/Sources/PulsumAgents/EstimatorStateStore.swift`: new secure store that checkpoints estimator weights/bias under Application Support and reloads on startup.
- `Packages/PulsumAgents/Sources/PulsumAgents/CoachAgent.swift`, `Packages/PulsumML/Sources/PulsumML/RecRanker.swift`: cached ranked feature vectors and wired acceptance/dismiss feedback into RecRanker updates with adaptive learning rate; aligned z-score weight signs.
- `Packages/PulsumML/Sources/PulsumML/Embedding/*`, `Packages/PulsumData/Sources/PulsumData/VectorIndexManager.swift`, `Packages/PulsumAgents/Sources/PulsumAgents/SentimentAgent.swift`, `Packages/PulsumML/Sources/PulsumML/SafetyLocal.swift`, `Packages/PulsumML/Sources/PulsumML/TopicGate/EmbeddingTopicGateProvider.swift`: re-enabled contextual AFM embeddings (availability-gated), removed zero-vector fallback by throwing on provider failure, enforced dimension checks, and propagated errors through consumers. AFM provider now short-circuits to generator-unavailable when Apple Intelligence isn’t ready, preventing startup log spam/hangs while still preferring on-device embeddings when available. `EmbeddingService` caches a non-PHI availability probe so chat coverage only fails closed when both AFM and Core ML fallbacks are unavailable.
- HealthKit access and ingestion now refresh off the shared service after authorization: Settings disables the request button when HealthKit is unavailable, re-runs the status probe after `AgentOrchestrator.start()`/requests, and keeps wellbeing/Settings cards in sync.
- `Packages/PulsumML/Sources/PulsumML/Embedding/EmbeddingService.swift` now self-heals availability with a timed/AFM-triggered re-probe instead of a one-shot cache; tests cover cooldown and cached-success behavior.
- `Packages/PulsumAgents/Sources/PulsumAgents/SentimentAgent.swift`, `Packages/PulsumUI/Sources/PulsumUI/PulseViewModel.swift`: journals persist even when embeddings are unavailable (flagged `embeddingPending`, toast copy updated) and can be reprocessed once embeddings come back.
- `Packages/PulsumAgents/Sources/PulsumAgents/RecRankerStateStore.swift`, `Packages/PulsumML/Sources/PulsumML/RecRanker.swift`, `Packages/PulsumAgents/Sources/PulsumAgents/CoachAgent.swift`: RecRanker state (weights + LR) now persists under Application Support with file protection/backup exclusion; feedback saves checkpoints and reloads on restart.
- `Packages/PulsumUI/Sources/PulsumUI/{PulsumRootView.swift,SettingsView.swift,CoachView.swift,CoachViewModel.swift}`, `Packages/PulsumAgents/Sources/PulsumAgents/AgentOrchestrator.swift`: added `WellbeingScoreState` (loading/ready/noData/error) so wellbeing cards stop spinning indefinitely and surface truthful copy for HealthKit unavailable/denied/no-data paths. No-data cards now drive a working “Request Health Data Access” action via the shared HealthKit service, and chat routing consults embedding availability before redirecting.
- `Packages/PulsumAgents/Sources/PulsumAgents/DataAgent.swift`, `Packages/PulsumAgents/Sources/PulsumAgents/BackfillStateStore.swift`: restored the 30-day analysis window with a two-phase backfill (7-day warm-start in the foreground, then persisted background batches to 30 days). Backfill progress is persisted on disk with full file protection/backup exclusion so relaunches resume where they left off instead of re-ingesting the entire history; observers still handle live anchors.
- `Packages/PulsumData/Sources/PulsumData/LibraryImporter.swift`, `Packages/PulsumAgents/Sources/PulsumAgents/CoachAgent.swift`, `Packages/PulsumML/Sources/PulsumML/Embedding/EmbeddingService.swift`: library ingestion now defers vector indexing when embeddings are unavailable (ingests Core Data, skips checksum) and CoachAgent falls back to keyword-based recommendations with a gentle notice; EmbeddingService exposes availability to drive this degradation so startup no longer fails when the generator is offline.
- Tests: added `Gate6_StateEstimatorWeightsAndLabelsTests`, `Gate6_StateEstimatorPersistenceTests`, `Gate6_RecRankerLearningTests` (PulsumAgents) and `Gate6_EmbeddingProviderContextualTests` plus stubbed `PackageEmbedTests`/topic gate tests (PulsumML) to lock behavior.
- Background backfill now stores per-type earliest processed dates and completion flags; warm-start completes once per type and background batches fetch older slices without blocking UI. Coverage/score breakdown increase as batches land.

## Tests & harness
- `swift build --package-path Packages/PulsumML -Xswiftc -strict-concurrency=complete` ✅
- `swift test --package-path Packages/PulsumML -Xswiftc -strict-concurrency=complete` (contextual/CoreML availability tests skip when models/APIs unavailable) ✅
- `swift build --package-path Packages/PulsumAgents -Xswiftc -strict-concurrency=complete` ✅
- `swift test --package-path Packages/PulsumAgents -Xswiftc -strict-concurrency=complete --filter "Gate6_"` ✅ (`Gate6_WellbeingBackfillPhasingTests` added for phased backfill + persistence)
- New coverage: `EmbeddingServiceAvailabilityTests` (self-heal/cooldown), `Gate6_SentimentJournalingFallbackTests` (journal persists on embedding failure), `Gate6_RecRankerPersistenceTests` (ranker state survives restart), `Gate6_WellbeingStateMappingTests` plus `SettingsViewModelHealthAccessTests` (HealthKit status/request refresh).

## Notes / non-blocking
- Contextual embedding test skips when platform APIs are unavailable; SafetyLocal still falls back to keyword-only classification if embeddings cannot be produced.
- Core Data model warnings appear in RecRanker feedback test due to parallel test models using the same class names; functional behavior verified.
- HealthKit 7-day window and status refresh are temporary mitigations; tasks remain to reintroduce 30-day coverage with incremental processing.
